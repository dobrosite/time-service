# Служба времени для PHP

Предоставляет интерфейс и простую реализацию службы для получения текущего времени и часового пояса.

Чем плох распространённый подход с определением текущего времени с помощью
`new DateTimeImmutable()`, `date_create()` и т. п.?

1. **Вы полагаетесь [глобальное состояние](https://habr.com/ru/company/vk/blog/454946/), которое не
   контролируете**. Достаточно какой-нибудь, используемой вами сторонней библиотеке изменить часовой
   пояс, и приведённые выше конструкции начнут возвращать время в другом часовом поясе. И это может
   происходить только при определённых условиях, что крайне трудно выявить при отладке.
2. **Такой код сложно тестировать**. Сравнение фактического и реального времени в тестах 
   превращается в лотерею с заданием допусков промежутков времени. Либо вообще происходит отказ
   от проверки времени в тестах.

Одно из возможных решений — служба времени, к которой обращается ваш код, чтобы узнать текущее
время. Пример:

```php
<?php
use DobroSite\TimeService\TimeService;

class SomeService {
  private TimeService $timeService;
  
  // Внедряем в ваш класс службу времени в качестве зависимости.
  public function __construct(TimeService $timeService)
  {
    $this->timeService = $timeService;
  }
  
  public function someMethod(): void
  {
    // Когда вам потребуется текущее время, обратитесь к службе времени:
    $currentTime = $this->timeService->getCurrentTime();
  }
}
```

1. Вы получаете полный контроль над временем в вашем приложении. Используя разные реализации
   интерфейса `TimeService` вы можете получать время из разных источников: системное время, сервер
   NTP и т. п. Так же вы можете задать в конфигурации нужный часовой пояс, который **не может быть
   изменён без вашего ведома** сторонним кодом.
2. Вы можете подменять в тестах службу времени тестовым двойником, чтобы тестируемый код получал
   заранее предопределённое время.
3. Написав свою реализацию, вы можете заставить ваше приложение перемещаться в будущее или прошлое,
   задавая нужное смещение относительно текущего времени. Это может быть полезно в приёмочном
   тестировании для проверки функций, которые должны выполниться через какой-то промежуток после
   некоторого действия.

## Установка

    composer require dobrosite/time-service

## Использование

### TimeService

Используйте интерфейс [TimeService] в качестве зависимости в классах, которым требуется получать
текущее время.

Вы можете написать свою реализацию этого интерфейса, либо воспользоваться готовыми реализациями:

- [PhpTimeService](src/PhpTimeService.php) — использует встроенные средства PHP.

## Тестирование

### [TestTimeService]

Тестовый двойник [TimeService] всегда возвращающий заданное время. Задать нужное время можно методом
`TestTimeService::setCurrentTime()`.

[TestTimeService]: src/Test/TestTimeService.php
[TimeService]: src/TimeService.php
